var KPS;(()=>{"use strict";var t={d:(e,o)=>{for(var i in o)t.o(o,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:o[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{Editor:()=>se});class o{constructor(t){this._editor=t,this._down=!1,this._dragPoint={x:0,y:0},this._downPoint={x:0,y:0},this._point={x:0,y:0},this._originPoint={x:0,y:0},this._curPoint={x:0,y:0},this._originEvent=null,this._clientPoint={x:0,y:0},this._keyPressed={}}get keyPressed(){return this._keyPressed}get editor(){return this._editor}get down(){return this._down}set down(t){this._down=t}get dragPoint(){return this._dragPoint}set dragPoint(t){this._dragPoint=t}get downPoint(){return this._downPoint}set downPoint(t){this._downPoint.x=t.x,this._downPoint.y=t.y}get point(){return this._point}set point(t){this._point=t.x,this._point=t.y}get originPoint(){return this._originPoint}set originPoint(t){this._originPoint=t}get curPoint(){return this._curPoint}set curPoint(t){this._curPoint=t}get originEvent(){return this._originEvent}set originEvent(t){return this._originEvent=t}get clientPoint(){return this._clientPoint}}const i="none",n="snap",s="drag_page",r="page_zoom",l="create_line",a="create_rect",h="create)triangle",d="create_circle",c="create_image",p="create_label",u="select";class g{get type(){return i}onDoubleClick(t){}onMouseDown(t){}onMouseMove(t){}onMouseUp(t){}onMouseWheel(t){}onKeyDown(t){}onKeyUp(t){}}class y extends g{constructor(){super()}get type(){return n}onMouseDown(t){t.down=!0,t.downPoint.x=t.point.x,t.downPoint.y=t.point.y,t.dragPoint.x=t.point.x,t.dragPoint.y=t.point.y,this.#t(t)}onMouseMove(t){this.#t(t);t.editor.page.coordinate.curPoint={x:t.originEvent.offsetX,y:t.originEvent.offsetY}}onMouseUp(t){t.down=!1,this.#t(t)}onMouseWheel(t){}onKeyDown(t){}onKeyUp(t){}#t(t){const e=t.editor.page.coordinate,o=e.dpr,i=t.point,n=t.originPoint;n.x=t.originEvent.offsetX,n.y=t.originEvent.offsetY,i.x=n.x/o,i.y=n.y/o;const s=e.orgPoint.x/o,r=e.orgPoint.y/o,l=-e.wayPoint.x-s,a=-e.wayPoint.y-r;i.x+=l,i.y+=a,t._clientPoint.x=t.originEvent.clientX,t._clientPoint.y=t.originEvent.clientY}}class x extends g{constructor(){super()}onKeyDown(t){if(!t.editor._enabledShortcut)return;const e=t.editor.tools,o=t.originEvent.key;if(t.originEvent.metaKey&&"1"===o)t.editor.capture();else switch(o){case"q":e.createLine(t.point);break;case"w":e.createRect(t.point);break;case"e":e.createTriangle(t.point);break;case"r":e.createCircle(t.point);break;case"t":e.createImage();break;case"a":e.createLabel(t.point);break;case"Escape":e.clear();break;case"z":e.undo();break;case"y":e.redo()}}onKeyUp(t){}}class m extends g{constructor(){super(),this.handlers=[],this.handlers.push(new y),this.handlers.push(new x)}onMouseDown(t){this.handlers.forEach((e=>{e.onMouseDown(t)}))}onMouseMove(t){this.handlers.forEach((e=>{e.onMouseMove(t)}))}onMouseUp(t){this.handlers.forEach((e=>{e.onMouseUp(t)}))}onMouseWheel(t){this.handlers.forEach((e=>{e.onMouseWheel(t)}))}onKeyDown(t){this.handlers.forEach((e=>{e.onKeyDown(t)}))}onKeyUp(t){this.handlers.forEach((e=>{e.onKeyUp(t)}))}}class b{constructor(t){this.event=new o(t),this.handler=new m,this.handlers=new Map,this.dragHandler=null}addHandler(t){this.handlers.set(t.type,t)}removeHandler(t){this.handlers.delete(t.type)}startDragHandler(t){this.dragHandler=t}finishDragHandler(){this.dragHandler=null}onDoubleClick(t){this.#t(t),this.handlers.forEach((t=>{t.onDoubleClick(this.event)}))}onMouseDown(t){this.#t(t),this.handler.onMouseDown(this.event),null===this.dragHandler?this.handlers.forEach((t=>{t.onMouseDown(this.event)})):this.dragHandler.onMouseDown(this.event)}onMouseMove(t){this.#t(t),this.handler.onMouseMove(this.event),null===this.dragHandler?this.handlers.forEach((t=>{t.onMouseMove(this.event)})):this.dragHandler.onMouseMove(this.event)}onMouseUp(t){this.#t(t),this.handler.onMouseUp(this.event),null===this.dragHandler?this.handlers.forEach((t=>{t.onMouseUp(this.event)})):this.dragHandler.onMouseUp(this.event)}onKeyDown(t){this.#t(t),this.handler.onKeyDown(this.event),null===this.dragHandler?this.handlers.forEach((t=>{t.onKeyDown(this.event)})):this.dragHandler.onKeyDown(this.event)}onMouseWheel(t){this.#t(t),this.handler.onMouseWheel(this.event),null===this.dragHandler?this.handlers.forEach((t=>{t.onMouseWheel(this.event)})):this.dragHandler.onMouseWheel(this.event)}onKeyUp(t){this.#t(t),this.handler.onKeyUp(this.event),null===this.dragHandler?this.handlers.forEach((t=>{t.onKeyUp(this.event)})):this.dragHandler.onKeyUp(this.event)}#t(t){this.event.originEvent=t}}const w="solid",_="dash";class v{constructor(t){this._ctx=t}get ctx(){return this._ctx}drawLabel(t){const e=t.minPoint.x,o=t.maxPoint.y;this.ctx.font=`${t.fontSize}px Arial`,this.ctx.fillStyle=t.fontColor,this.ctx.textBaseline="bottom",this.ctx.fillText(t.text,e,o)}drawLine(t,e,o="black",i=1,n=1,s=w){return this.start(),this.lineOption(o,i,n,s),this.line(t,e),this.lineEnd(),this.end(),this}lineOption(t="black",e=1,o=1,i=w){const n=this._ctx;n.strokeStyle=t,n.lineWidth=e,n.globalAlpha=o,i!==w&&this.ctx.setLineDash([5,5])}line(t,e){const o=this._ctx;o.moveTo(t.x,t.y),o.lineTo(e.x,e.y)}lineEnd(){this.ctx.stroke()}start(){const t=this._ctx;t.save(),t.beginPath()}end(){const t=this._ctx;t.closePath(),t.restore()}drawRect(t){const e=t.lt,o=t.rt,i=t.rb,n=t.lb,s=this.ctx;s.moveTo(e.x,e.y),s.lineTo(o.x,o.y),s.lineTo(i.x,i.y),s.lineTo(n.x,n.y),s.lineTo(e.x,e.y),this.lineEnd()}drawTriangle(t){const e=t.top,o=t.left,i=t.right,n=this.ctx;n.moveTo(e.x,e.y),n.lineTo(o.x,o.y),n.lineTo(i.x,i.y),n.lineTo(e.x,e.y),this.lineEnd()}drawCircle(t){this.ctx.ellipse(t.p.x,t.p.y,t.xRadius,t.yRadius,0,0,2*Math.PI),this.lineEnd()}fill(t,e=1){const o=this.ctx;o.fillStyle=t,o.globalAlpha=e,o.fill()}drawImage(t,e,o,i,n){this._ctx.drawImage(t,e,o,i,n)}}class C{constructor(){this._curPoint={x:0,y:0},this._orgPoint={x:0,y:0},this._wayPoint={x:0,y:0},this._dpr=window.devicePixelRatio}get curPoint(){return this._curPoint}set curPoint(t){this._curPoint=t}get orgPoint(){return this._orgPoint}set orgPoint(t){this._orgPoint=t}get wayPoint(){return this._wayPoint}set wayPoint(t){this._wayPoint.x=t.x,this._wayPoint.y=t.y}get dpr(){return this._dpr}set dpr(t){this._dpr=t}}class f{constructor(t){this.ctx=t,this.ctx.canvas.cursor="move",this._painter=new v(t),this._coordinate=new C,this._controls=[],this._newControl=null,this._selectControls=[],this._selectControl=null,this._hoverControl=null,this.gridSize=25,this.gridCount=5,this.gridRender=!0}get controls(){return this._controls}get newControl(){return this._newControl}set newControl(t){this._newControl=t}get selectControls(){return this._selectControls}get selectControl(){return this._selectControl}set selectControl(t){this._selectControl=t}get hoverControl(){return this._hoverControl}set hoverControl(t){this._hoverControl=t}get painter(){return this._painter}setCursor(t){this.ctx.canvas.style.cursor=t}get coordinate(){return this._coordinate}addControl(t){this.controls.push(t),this.render()}removeControl(t){this._controls=this.controls.filter((e=>e!==t)),t===this.selectControl?.control&&(this.selectControl=null,this.hoverControl=null),this.render()}render(){this.transform(),this.renderBackground(),this._controls.forEach((t=>{t.render(this.painter)})),this.hoverControl?.render(this.painter),this.selectControl?.render(this.painter)}captureRender(){this.gridRender=!1,this.render(),this.gridRender=!0}renderBackground(){this.renderGrid()}renderGrid(){const t=this.coordinate,e=t.dpr,o=t.wayPoint,i=t.orgPoint,n=this.ctx.canvas.width/e,s=this.ctx.canvas.height/e,r=-i.x/e-o.x,l=r+n,a=-i.y/e-o.y,h=a+s;this.ctx.clearRect(r-1,a-1,n+2,s+2),this.gridRender&&(this.renderGridLine(r,l,a,h,!0),this.renderGridLine(a,h,r,l,!1))}renderGridLine(t,e,o,i,n){const s=this.gridSize;let r=t%s,l=Math.floor(t/s);0!==r&&(l=t<0?l-1:l+1,t=l*s);for(let r=t;r<e;){const t=l%this.gridCount==0?2:1,e=l%this.gridCount==0?"rgba(0, 0, 0, 0.6)":"rgb(129, 138, 138)",a=this.getLinePoint({x:r,y:o},{x:r,y:i},n);this.painter.drawLine(a.p1,a.p2,e,t,.5),r+=s,++l}}getLinePoint(t,e,o){return o?{p1:t,p2:e}:{p1:{x:t.y,y:t.x},p2:{x:e.y,y:e.x}}}scaleIn(){this._coordinate.dpr>10||(this.scale(1.05),this.render())}scaleOut(){this._coordinate.dpr<.1||(this.scale(.95),this.render())}scale(t){const e=this._coordinate;e.dpr*=t;const o=e.orgPoint.x,i=e.orgPoint.y;e.orgPoint={x:e.curPoint.x-(e.curPoint.x-o)*t,y:e.curPoint.y-(e.curPoint.y-i)*t},this.transform()}transform(){const t=this.coordinate.orgPoint,e=this.coordinate.wayPoint,o=this.coordinate.dpr,i=e.x*o,n=e.y*o;this.ctx.setTransform(o,0,0,o,t.x+i,t.y+n)}}class P{constructor(t){this.editor=t}active(){}deActive(){}}class M{constructor(){this._lt={x:0,y:0},this._rt={x:0,y:0},this._rb={x:0,y:0},this._lb={x:0,y:0}}get lt(){return this._lt}get rt(){return this._rt}get rb(){return this._rb}get lb(){return this._lb}updatePosition(t,e){this.lt.x=t.x,this.lt.y=t.y,this.rb.x=e.x,this.rb.y=e.y,this.rt.x=e.x,this.rt.y=t.y,this.lb.x=t.x,this.lb.y=e.y}}class E{static checkDragPosition(t,e,o){Math.abs(e.x-o.x)<=10&&Math.abs(e.y-o.y)<=10&&t.setPosition(o)}static generateResizeRect(t){const e=new M;return e.updatePosition({x:t.x-2,y:t.y-2},{x:t.x+2,y:t.y+2}),e}static ptInLine(t,e){let o=t.x,i=t.y,n=e.p1.x,s=e.p1.y,r=e.p2.x,l=e.p2.y;const a=Math.sqrt((r-n)**2+(l-s)**2);return Math.sqrt((n-o)**2+(s-i)**2)+Math.sqrt((r-o)**2+(l-i)**2)-a<=1}}const T="none",R="left",L="right",S="top",z="bottom",k="left-top",I="right-top",U="right-bottom",H="left-bottom";class D{constructor(t){this._control=t,this._resizeType=T}get control(){return this._control}get resizeType(){return this._resizeType}set resizeType(t){this._resizeType=t}render(t){}}class W extends D{constructor(t){super(t)}render(t){const e=this.control;t.drawLine(e.p1,e.p2,"grey",1,.5)}}class B{constructor(t,e){this.name=t,this.runner=e}run(){this.runner()}}class O extends g{constructor(t){super(),this.line=t.page.newControl,this.editor=t,t.addForegroundRender(new W(this.line)),t.historyManager.startUndo(new B("undo create line",(()=>{t.page.removeControl(this.line)})))}get type(){return l}onMouseDown(t){t.editor.page.selectControl=null}onMouseMove(t){t.down?(this.line.p1.x=t.downPoint.x,this.line.p1.y=t.downPoint.y,this.line.p2.x=t.point.x,this.line.p2.y=t.point.y):this.line.setPosition(t.point),this.editor.render()}onMouseUp(t){E.checkDragPosition(this.line,t.downPoint,t.point),this.line.updatePosition(),this.editor.removeForegroundRender(),this.editor.clearCommand(),t.editor.page.addControl(this.line),t.editor.historyManager.endUndo(new B("redo create line",(()=>{this.editor.page.addControl(this.line)})))}onMouseWheel(t){}onKeyDown(t){}onKeyUp(t){}}class F extends P{constructor(t){super(t),this.handler=new O(t)}active(){this.editor.addEventHandler(this.handler)}deActive(){this.editor.removeEventHandler(this.handler)}}class K extends D{constructor(t){super(t)}render(t){t.start(),t.lineOption("grey",1,.5),t.drawRect(this.control),t.fill(this.control.fillColor,.1),t.end()}}class A extends g{constructor(t){super(),this.editor=t,this.rect=t.page.newControl,t.addForegroundRender(new K(this.rect)),t.historyManager.startUndo(new B("undo create rect",(()=>{t.page.removeControl(this.rect)})))}get type(){return a}onMouseDown(t){t.editor.page.selectControl=null}onMouseMove(t){const e=this.rect;t.down?(e.lt.x=t.downPoint.x,e.lt.y=t.downPoint.y,e.rt.x=t.point.x,e.rt.y=t.downPoint.y,e.rb.x=t.point.x,e.rb.y=t.point.y,e.lb.x=t.downPoint.x,e.lb.y=t.point.y):e.setPosition(t.point),this.editor.render()}onMouseUp(t){E.checkDragPosition(this.rect,t.downPoint,t.point),this.rect.updatePosition(),this.editor.removeForegroundRender(),this.editor.clearCommand(),t.editor.page.addControl(this.rect),t.editor.historyManager.endUndo(new B("redo create rect",(()=>{this.editor.page.addControl(this.rect)})))}}class N extends P{constructor(t){super(t),this.handler=new A(t)}active(){this.editor.addEventHandler(this.handler)}deActive(){this.editor.removeEventHandler(this.handler)}}class j{constructor(){this.command=null}execute(t){this.command?.deActive(),t.active(),this.command=t}}class Q extends g{constructor(){super()}get type(){return s}onMouseMove(t){if(!t.down)return;const e=t.editor.page,o=e.coordinate,i=t.downPoint,n=t.point.x-i.x,s=t.point.y-i.y;o.orgPoint;o.wayPoint.x+=n,o.wayPoint.y+=s,e.render()}onMouseUp(t){t.editor.finishDragHandler()}}class Y extends B{constructor(t,e){const o=[];e.points.forEach(((t,e)=>{o[e]=t.copy()}));const i=e?.fontSize??0;super(t,(()=>{for(let t=0;t<e.points.length;++t)e.points[t]=o[t];e.updatePosition(),0!==i&&(e.fontSize=i)}))}}class G extends g{onMouseMove(t){const e=t.editor.page.selectControl.control,o=t.point.x-t.downPoint.x,i=t.point.y-t.downPoint.y;e.move({x:o,y:i}),t.downPoint.x=t.point.x,t.downPoint.y=t.point.y,e.updateSelectPosition(),t.editor.page.render()}onMouseUp(t){t.editor.finishDragHandler();const e=Math.abs(t.dragPoint.x-t.point.x),o=Math.abs(t.dragPoint.y-t.point.y);e<=1&&o<=1||t.editor.historyManager.endUndo(new Y("redo move",t.editor.page.selectControl.control))}}const X="default",q="move",$="nwse-resize",Z="nesw-resize",J="ew-resize",V="ns-resize",tt="text";class et extends g{onMouseMove(t){const e=t.editor.page.selectControl,o=e.resizeType,i=t.point.x-t.downPoint.x,n=t.point.y-t.downPoint.y;t.downPoint.x=t.point.x,t.downPoint.y=t.point.y,e.control.resize(o,{x:i,y:n}),t.editor.render()}onMouseUp(t){const e=t.editor.page.selectControl.control;e.updatePointPosition(),e.updatePointRatio(),t.editor.finishDragHandler();const o=Math.abs(t.dragPoint.x-t.point.x),i=Math.abs(t.dragPoint.y-t.point.y);o<=1&&i<=1||t.editor.historyManager.endUndo(new Y("redo Resize",e))}}class ot extends D{constructor(t){super(t),this.selectionRect=new M}render(t){const e=this.control;e.updateSelectPosition(),this.selectionRect.updatePosition(e.minPoint,e.maxPoint);const o=this.selectionRect;t.start(),t.lineOption("rgb(53,155,255)",1,.8),t.drawRect(o),t.end(),t.start(),t.lineOption("black");let i=E.generateResizeRect(o.lt);t.drawRect(i),i=E.generateResizeRect(o.rt),t.drawRect(i),i=E.generateResizeRect(o.rb),t.drawRect(i),i=E.generateResizeRect(o.lb),t.drawRect(i),t.fill("white"),t.end()}}const it="none",nt="line",st="rect",rt="triangle",lt="circle",at="image",ht="label",dt="polygon";class ct{constructor(){this._lineWidth=1,this._lineColor="black",this._lineStyle=w,this._fillColor="rgb(189,246,197)",this._opacity=.5,this._select=!1,this._hover=!1,this._minPoint={x:0,y:0},this._maxPoint={x:0,y:0},this.selectionRect=new M}get type(){return it}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t}get lineColor(){return this._lineColor}set lineColor(t){this._lineColor=t}get lineStyle(){return this._lineStyle}set lineStyle(t){this._lineStyle=t}get fillColor(){return this._fillColor}set fillColor(t){this._fillColor=t}get opacity(){return this._opacity}get select(){return this._select}set select(t){this._select=t}get hover(){return this._hover}set hover(t){this._hover=t}get minPoint(){return this._minPoint}get maxPoint(){return this._maxPoint}get width(){return this.maxPoint.x-this.minPoint.x}get height(){return this.maxPoint.y-this.minPoint.y}updatePosition(){this.updateSelectPosition(),this.updatePointPosition(),this.updatePointRatio()}updateSelectPosition(){}updatePointPosition(){}updatePointRatio(){}move(t){}resize(t,e){}setPosition(t){}render(t){}ptInControl(t){return!1}ptInHoverControl(t){return null}ptInSelectControl(t){return this.ptInControl(t)?new ot(this):null}ptInResizePoint(t){this.selectionRect.updatePosition(this.minPoint,this.maxPoint);const e=this.selectionRect.lt,o=this.selectionRect.rt,i=this.selectionRect.rb,n=this.selectionRect.lb;return this.#e(E.generateResizeRect(e),t)?k:this.#e(E.generateResizeRect(o),t)?I:this.#e(E.generateResizeRect(i),t)?U:this.#e(E.generateResizeRect(n),t)?H:E.ptInLine(t,{p1:e,p2:n})?R:E.ptInLine(t,{p1:o,p2:i})?L:E.ptInLine(t,{p1:e,p2:o})?S:E.ptInLine(t,{p1:n,p2:i})?z:T}#e(t,e){return t.lt.x<=e.x&&e.x<=t.rb.x&&t.lt.y<=e.y&&e.y<=t.rb.y}}const pt=-50,ut=-30,gt=10,yt=60,xt=100,mt=30;class bt{static instance;constructor(){}static getInstance(){return this.instance||(this.instance=this,this.lineOptionToolbar=document.getElementById("line-option"),this.lineWidthToolbar=document.getElementById("line-width"),this.lineStyleToolbar=document.getElementById("line-style"),this.lineColorToolbar=document.getElementById("line-color"),this.fillColorToolbar=document.getElementById("fill-color"),this.fillColorBtn=document.getElementById("fill-color-btn"),this.fontOptionToolbar=document.getElementById("font-option"),this.fontColorToolbar=document.getElementById("font-color"),this.fontSize=document.getElementById("font-size")),this.instance}static showFontOptionToolbar(t,e){this.fontOptionToolbar.classList.remove("hidden"),this.fontOptionToolbar.style.top=t.y+"px",this.fontOptionToolbar.style.left=t.x+"px",this.fontSize.value=Math.round(e.fontSize),this.#o(this.fontOptionToolbar,t.x)}static hideFontOptionToolbar(){this.fontOptionToolbar.classList.add("hidden"),this.fontColorToolbar.classList.add("hidden")}static showControlOptionToolbar(t,e){if(e.type===ht)return this.clear(),void this.showFontOptionToolbar(t,e);this.lineOptionToolbar.classList.remove("hidden"),this.lineWidthToolbar.classList.add("hidden"),this.lineStyleToolbar.classList.add("hidden"),this.lineColorToolbar.classList.add("hidden"),this.fillColorToolbar.classList.add("hidden"),e.type===nt||e.type===at?this.fillColorBtn.classList.add("hidden"):this.fillColorBtn.classList.remove("hidden"),this.lineOptionToolbar.style.top=t.y+"px",this.lineOptionToolbar.style.left=t.x+"px",this.#o(this.lineOptionToolbar,t.x)}static hideLineOptionToolbar(){this.lineOptionToolbar.classList.add("hidden"),this.lineWidthToolbar.classList.add("hidden"),this.lineStyleToolbar.classList.add("hidden"),this.lineColorToolbar.classList.add("hidden"),this.fillColorToolbar.classList.add("hidden")}static showLineWidthToolbar(){this.lineWidthToolbar.classList.remove("hidden"),this.lineStyleToolbar.classList.add("hidden"),this.lineColorToolbar.classList.add("hidden"),this.fillColorToolbar.classList.add("hidden"),this.#o(this.lineWidthToolbar,ut)}static showLineStyleToolbar(){this.lineStyleToolbar.classList.remove("hidden"),this.lineWidthToolbar.classList.add("hidden"),this.lineColorToolbar.classList.add("hidden"),this.fillColorToolbar.classList.add("hidden")}static showLineColorToolbar(){this.lineColorToolbar.classList.remove("hidden"),this.lineStyleToolbar.classList.add("hidden"),this.lineWidthToolbar.classList.add("hidden"),this.fillColorToolbar.classList.add("hidden"),this.#o(this.lineColorToolbar,yt)}static showFillColorToolbar(){this.fillColorToolbar.classList.remove("hidden"),this.lineColorToolbar.classList.add("hidden"),this.lineStyleToolbar.classList.add("hidden"),this.lineWidthToolbar.classList.add("hidden"),this.#o(this.fillColorToolbar,xt)}static showFontColorToolbar(){this.fontColorToolbar.classList.remove("hidden"),this.#o(this.fontColorToolbar,mt)}static#o(t,e){const o=t.getBoundingClientRect(),i=window.innerWidth||document.documentElement.clientWidth,n=o.right-i;let s=t.style.left.replace("px","");n>=0?(s-=n,t.style.left=s+"px"):t.style.left=e+"px"}static clear(){this.hideLineOptionToolbar(),this.hideFontOptionToolbar()}}class wt extends g{constructor(){super()}get type(){return u}onDoubleClick(t){const e=t.editor.page;if(e?.selectControl?.control?.type===ht){const e=t.editor.page.selectControl.control;t.editor.textEditor.updateLabel(e);const o=e.lt,i=t.point,n={x:i.x-o.x,y:i.y-o.y},s=t.editor.page.coordinate.dpr;n.x*=s,n.y*=s,t.editor.textEditor.show({x:t.clientPoint.x-n.x,y:t.clientPoint.y-n.y}),t.editor.tools.editeLabel(),bt.getInstance().clear()}}onMouseDown(t){const e=t.editor.page;if(null!==e.selectControl&&e.selectControl.resizeType!==T)return t.editor.historyManager.startUndo(new Y("undo resize",e.selectControl.control)),void t.editor.startDragHandler(new et);let o=null;const i=e.controls;for(const e of i)if(o=e.ptInSelectControl(t.point),null!==o)break;e.selectControl=o,null===o&&(bt.getInstance().hideLineOptionToolbar(),t.editor.startDragHandler(new Q)),e.render()}onMouseMove(t){const e=t.editor.page;if(e.coordinate.curPoint={x:t.originEvent.offsetX,y:t.originEvent.offsetY},t.down&&null!==e.selectControl)return e.setCursor(q),t.editor.historyManager.startUndo(new Y("undo move",e.selectControl.control)),void t.editor.startDragHandler(new G);let o=null;const i=e.controls;for(const e of i)if(o=e.ptInHoverControl(t.point),null!==o)break;if(null!==e.selectControl){const i=e.selectControl.control.ptInResizePoint(t.point);e.selectControl.resizeType=i,i===k||i===U?e.setCursor($):i===I||i===H?e.setCursor(Z):i===R||i===L?e.setCursor(J):i===S||i===z?e.setCursor(V):null!==o&&e.selectControl.control===o.control?e.setCursor(q):e.setCursor(X),e.selectControl.control.type!==ht||i!==R&&i!==L&&i!==S&&i!==z||(e.setCursor(X),e.selectControl.resizeType=T)}else e.setCursor(X);e.hoverControl=o,e.render()}onMouseUp(t){const e=t.editor.page;null!==e.selectControl&&bt.getInstance().showControlOptionToolbar(t.originPoint,e.selectControl.control)}onMouseWheel(t){}onKeyDown(t){}onKeyUp(t){}}class _t extends g{get type(){return r}onMouseWheel(t){const e=t.editor.page;t.originEvent.deltaY<0?e.scaleIn():e.scaleOut(),e.render()}}class vt extends P{constructor(t){super(),this.editor=t,this.handlers=[],this.handlers.push(new _t),this.handlers.push(new wt)}active(){this.handlers.forEach((t=>{this.editor.addEventHandler(t)}))}deActive(){this.handlers.forEach((t=>{this.editor.removeEventHandler(t)}))}}class Ct extends D{constructor(t){super(t)}render(t){t.start(),t.lineOption("grey",1,.5),t.drawTriangle(this.control),t.fill(this.control.fillColor,.1),t.end()}}class ft extends g{constructor(t){super(),this.editor=t,this.triangle=t.page.newControl,t.addForegroundRender(new Ct(this.triangle)),t.historyManager.startUndo(new B("undo create triangle",(()=>{t.page.removeControl(this.triangle)})))}get type(){return h}onMouseDown(t){t.editor.page.selectControl=null}onMouseMove(t){if(t.down){const e=t.point.x-t.downPoint.x;this.triangle.top.x=t.downPoint.x+e/2,this.triangle.top.y=t.downPoint.y,this.triangle.left.x=t.downPoint.x,this.triangle.left.y=t.point.y,this.triangle.right.x=t.point.x,this.triangle.right.y=t.point.y}else this.triangle.setPosition(t.point);t.editor.render()}onMouseUp(t){E.checkDragPosition(this.triangle,t.downPoint,t.point),this.triangle.updatePosition(),this.editor.removeForegroundRender(),this.editor.clearCommand(),t.editor.page.addControl(this.triangle),t.editor.historyManager.endUndo(new B("redo create triangle",(()=>{this.editor.page.addControl(this.triangle)})))}onKeyUp(t){super.onKeyUp(t)}}class Pt extends P{constructor(t){super(),this.editor=t,this.handler=new ft(t)}active(){this.editor.addEventHandler(this.handler)}deActive(){this.editor.removeEventHandler(this.handler)}}class Mt extends D{constructor(t){super(t)}render(t){const e=this.control;t.start(),t.lineOption(e.lineColor,e.lineWidth,.5),t.drawCircle(e),t.fill(e.fillColor,.1),t.end()}}class Et extends g{constructor(t){super(),this.editor=t,this.circle=t.page.newControl,t.addForegroundRender(new Mt(this.circle)),t.historyManager.startUndo(new B("undo create circle",(()=>{t.page.removeControl(this.circle)})))}get type(){return d}onMouseDown(t){t.editor.page.selectControl=null}onMouseMove(t){t.down?(this.circle.lt.x=t.downPoint.x,this.circle.lt.y=t.downPoint.y,this.circle.rt.x=t.point.x,this.circle.rt.y=t.downPoint.y,this.circle.rb.x=t.point.x,this.circle.rb.y=t.point.y,this.circle.lb.x=t.downPoint.x,this.circle.lb.y=t.point.y):this.circle.setPosition(t.point),this.editor.render()}onMouseUp(t){E.checkDragPosition(this.circle,t.downPoint,t.point),this.circle.updatePosition(),this.editor.removeForegroundRender(),this.editor.clearCommand(),t.editor.historyManager.endUndo(new B("redo create circle",(()=>{this.editor.page.addControl(this.circle)}))),t.editor.page.addControl(this.circle)}}class Tt extends P{constructor(t){super(t),this.handler=new Et(t)}active(){this.editor.addEventHandler(this.handler)}deActive(){this.editor.removeEventHandler(this.handler)}}class Rt extends D{constructor(t){super(),this.imageRect=t}render(t){const e=this.imageRect,o=e.rb.x-e.lt.x,i=e.rb.y-e.lt.y;t.drawImage(this.imageRect.image,e.lt.x,e.lt.y,o,i)}}class Lt extends ct{constructor(){super(),this._points=[]}get type(){return dt}get points(){return this._points}resize(t,e){this._points.forEach((o=>{switch(t){case k:this.#i(e,o);break;case I:this.#n(e,o);break;case U:this.#s(e,o);break;case H:this.#r(e,o);break;case R:this.#l(e,o);break;case L:this.#a(e,o);break;case S:this.#h(e,o);break;case z:this.#d(e,o)}}))}#l(t,e){switch(e.position){case S:case z:e.x+=t.x*e.xRatio;break;case R:case k:case H:e.x+=t.x;break;case L:case I:case U:return;default:e.x+=t.x*e.xRatio}}#a(t,e){switch(e.position){case S:case z:e.x+=t.x*e.xRatio;break;case L:case I:case U:e.x+=t.x;break;case R:case k:case H:return;default:e.x+=t.x*e.xRatio}}#h(t,e){switch(e.position){case R:case L:e.y+=t.y*e.yRatio;break;case S:case k:case I:e.y+=t.y;break;case z:case H:case U:return;default:e.y+=t.y*e.yRatio}}#d(t,e){switch(e.position){case R:case L:e.y+=t.y*e.yRatio;break;case z:case H:case U:e.y+=t.y;break;case S:case k:case I:return;default:e.y+=t.y*e.yRatio}}#i(t,e){this.#l(t,e),this.#h(t,e)}#n(t,e){this.#a(t,e),this.#h(t,e)}#s(t,e){this.#a(t,e),this.#d(t,e)}#r(t,e){this.#l(t,e),this.#d(t,e)}updateSelectPosition(){0!==this.points.length&&(this.minPoint.x=this.points[0].x,this.minPoint.y=this.points[0].y,this.maxPoint.x=this.points[0].x,this.maxPoint.y=this.points[0].y,this.points.forEach((t=>{this.minPoint.x=Math.min(this.minPoint.x,t.x),this.minPoint.y=Math.min(this.minPoint.y,t.y),this.maxPoint.x=Math.max(this.maxPoint.x,t.x),this.maxPoint.y=Math.max(this.maxPoint.y,t.y)})))}updatePointPosition(){this.points.forEach((t=>{t.x===this.minPoint.x&&t.y===this.minPoint.y?t.position=k:t.x===this.maxPoint.x&&t.y===this.maxPoint.y?t.position=U:t.x===this.maxPoint.x&&t.y===this.minPoint.y?t.position=I:t.x===this.minPoint.x&&t.y===this.maxPoint.y?t.position=H:t.x===this.minPoint.x?t.position=R:t.x===this.maxPoint.x?t.position=L:t.y===this.minPoint.y?t.position=S:t.y===this.maxPoint.y?t.position=z:t.position=T}))}updatePointRatio(){this._points.forEach((t=>{const e=t.x-this.minPoint.x,o=t.y-this.minPoint.y;t.xRatio=e/this.width,t.yRatio=o/this.height}))}move(t){this._points.forEach((e=>{e.x+=t.x,e.y+=t.y}))}render(t){const e=this._points,o=t.ctx;t.start(),t.lineOption(this.lineColor,this.lineWidth,1,this.lineStyle),o.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;++t){const i=e[t];o.lineTo(i.x,i.y)}const i=e[0];o.lineTo(i.x,i.y),t.lineEnd(),o.lineWidth=this.lineWidth,"none"!==this.fillColor&&t.fill(this.fillColor,this.opacity),t.end()}ptInControl(t){let e=t.x,o=t.y,i=!1;const n=this.points;for(let t=0,s=n.length-1;t<n.length;s=t++){let r=n[t].x,l=n[t].y,a=n[s].x,h=n[s].y;l>o!=h>o&&e<(a-r)*(o-l)/(h-l)+r&&(i=!i)}return i}ptInHoverControl(t){super.ptInHoverControl(t)}ptInSelectControl(t){return super.ptInSelectControl(t)}}class St extends D{constructor(t){super(t)}render(t){t.start(),t.lineOption("grey",0),t.drawRect(this.control),t.fill("rgb(53,155,255)",.5),t.end()}}class zt{constructor(t){return this._x=0,this._y=0,this._xRatio=0,this._yRatio=0,this._position=t??T,this}get x(){return this._x}set x(t){this._x=t}get xRatio(){return this._xRatio}set xRatio(t){this._xRatio=t}get yRatio(){return this._yRatio}set yRatio(t){this._yRatio=t}get y(){return this._y}set y(t){this._y=t}get position(){return this._position}set position(t){this._position=t}copy(){const t=new zt(this.position);return t.x=this.x,t.y=this.y,t.xRatio=this.xRatio,t.yRatio=this.yRatio,t}}class kt extends Lt{constructor(){super(),this._lt=new zt(k),this._rt=new zt(I),this._rb=new zt(U),this._lb=new zt(H),this.points.push(this._lt),this.points.push(this._rt),this.points.push(this._rb),this.points.push(this._lb)}get type(){return st}get lt(){return this._lt}get rt(){return this._rt}get rb(){return this._rb}get lb(){return this._lb}updateSelectPosition(){super.updateSelectPosition()}updatePointPosition(){super.updatePointPosition(),this.points.forEach((t=>{switch(t.position){case k:this._lt=t;break;case I:this._rt=t;break;case U:this._rb=t;break;case H:this._lb=t}}))}move(t){super.move(t)}resize(t,e){super.resize(t,e)}setPosition(t){this._lt.x=t.x,this._lt.y=t.y,this._rt.x=t.x+50,this._rt.y=t.y,this._rb.x=t.x+50,this._rb.y=t.y+50,this._lb.x=t.x,this._lb.y=t.y+50}render(t){super.render(t)}ptInControl(t){return super.ptInControl(t)}ptInHoverControl(t){return this.ptInControl(t)?new St(this):null}}class It extends kt{constructor(t){super(),this._image=t,this.fillColor="none"}get type(){return at}get image(){return this._image}setPosition(t){super.setPosition(t)}render(t){const e=this.rb.x-this.lt.x,o=this.rb.y-this.lt.y;t.drawImage(this._image,this.lt.x,this.lt.y,e,o),super.render(t)}}class Ut extends g{constructor(t,e){super(),this.editor=t,this.image=new It(e),t.addForegroundRender(new Rt(this.image)),t.historyManager.startUndo(new B("undo create image",(()=>{t.page.removeControl(this.image)})))}get type(){return c}onMouseDown(t){t.editor.page.selectControl=null}onMouseMove(t){const e=this.image;t.down?(e.lt.x=t.downPoint.x,e.lt.y=t.downPoint.y,e.rt.x=t.point.x,e.rt.y=t.downPoint.y,e.rb.x=t.point.x,e.rb.y=t.point.y,e.lb.x=t.downPoint.x,e.lb.y=t.point.y):e.setPosition(t.point),this.editor.render()}onMouseUp(t){E.checkDragPosition(this.image,t.downPoint,t.point),this.image.updatePosition(),this.editor.removeForegroundRender(),this.editor.clearCommand(),t.editor.page.addControl(this.image),t.editor.historyManager.endUndo(new B("redo create image",(()=>{this.editor.page.addControl(this.image)})))}}class Ht extends P{constructor(t,e){super(t),this.handler=new Ut(t,e)}active(){this.editor.addEventHandler(this.handler)}deActive(){this.editor.removeEventHandler(this.handler)}}class Dt extends D{constructor(t){super(t)}render(t){const e=this.control;t.drawLine(e.p1,e.p2,"rgb(53,155,255)",3,.5)}}class Wt extends Lt{constructor(){super(),this._p1=new zt(k),this._p2=new zt(U),this.points.push(this.p1),this.points.push(this.p2)}get type(){return nt}get p1(){return this._p1}get p2(){return this._p2}setPosition(t){this.p1.x=t.x,this.p1.y=t.y,this.p2.x=t.x+50,this.p2.y=t.y+50}updateSelectPosition(){super.updateSelectPosition()}move(t){super.move(t)}resize(t,e){super.resize(t,e)}render(t){t.drawLine(this.p1,this.p2,this.lineColor,this.lineWidth,1,this.lineStyle)}ptInControl(t){return E.ptInLine(t,this)}ptInHoverControl(t){return this.ptInControl(t)?new Dt(this):null}ptInSelectControl(t){return super.ptInSelectControl(t)}}class Bt extends D{constructor(t){super(t)}render(t){t.start(),t.lineOption("grey",0,.5),t.drawTriangle(this.control),t.fill("rgb(53,155,255)",.5),t.end()}}class Ot extends Lt{constructor(){super(),this._top=new zt(S),this._left=new zt(H),this._right=new zt(U),this.points.push(this._top),this.points.push(this._left),this.points.push(this._right)}get type(){return rt}get top(){return this._top}get left(){return this._left}get right(){return this._right}updateSelectPosition(){super.updateSelectPosition()}updatePointPosition(){super.updatePointPosition(),this.points.forEach((t=>{switch(t.position){case z:case S:this._top=t;break;case k:case H:this._left=t;break;case I:case U:this._right=t}}))}move(t){super.move(t)}resize(t,e){return super.resize(t,e)}setPosition(t){this.top.x=t.x+25,this.top.y=t.y,this.left.x=t.x,this.left.y=t.y+50,this.right.x=t.x+50,this.right.y=t.y+50}render(t){super.render(t)}ptInControl(t){return super.ptInControl(t)}ptInHoverControl(t){return this.ptInControl(t)?new Bt(this):null}}class Ft extends D{constructor(t){super(t)}render(t){const e=this.control;t.start(),t.lineOption(e.lineColor,0,.5),t.drawCircle(e),t.fill("rgb(53,155,255)",.5),t.end()}}class Kt extends kt{constructor(){super()}get type(){return lt}get p(){return{x:(this.rb.x+this.lt.x)/2,y:(this.rb.y+this.lt.y)/2}}get xRadius(){return Math.abs(this.rb.x-this.lt.x)/2}get yRadius(){return Math.abs(this.rb.y-this.lt.y)/2}resize(t,e){super.resize(t,e)}updateSelectPosition(){super.updateSelectPosition()}move(t){super.move(t)}setPosition(t){super.setPosition(t)}render(t){const e=t.ctx;t.start(),t.lineOption(this.lineColor,this.lineWidth,1,this.lineStyle),e.ellipse(this.p.x,this.p.y,this.xRadius,this.yRadius,0,0,2*Math.PI),t.lineEnd(),e.fillStyle=this.fillColor,e.fill(),t.end()}ptInControl(t){const e=this.p,o=t.x-e.x,i=t.y-e.y;return o*o/(this.xRadius*this.xRadius)+i*i/(this.yRadius*this.yRadius)<=1}ptInHoverControl(t){return this.ptInControl(t)?new Ft(this):null}ptInSelectControl(t){return super.ptInSelectControl(t)}}class At{static _editor;static setEditor(t){this._editor||(this._editor=t)}static calculatorFontSize(t,e,o){const i=this._editor.ctx;i.save(),i.font=`${o} Arial`;const n=i.measureText(t).width??.1;i.restore();let s=e/n;return s<=0||n<=0?.1:o*s}static calculatorFontWidthHeight(t,e,o){const i=this._editor.ctx;i.save(),i.fontSize=`${e} Arial`,i.restore();const n=document.createElement("span");n.style.visibility="hidden",n.style.whiteSpace="pre",n.style.fontSize=e+"px",n.textContent=t,i.save(),i.font=`${e} Arial`;i.measureText(t).width;i.restore(),document.body.appendChild(n);const s=n.offsetWidth,r=n.offsetHeight;return document.body.removeChild(n),{width:s,height:r}}static getWhiteSpace(){return 16*this._editor.page.coordinate.dpr}}class Nt extends kt{constructor(){super(),this._text="",this._fontSize=20,this._fontColor="rgb(0, 0, 0)"}get type(){return ht}get text(){return this._text}set text(t){this._text=t}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t}get fontColor(){return this._fontColor}set fontColor(t){this._fontColor=t}resize(t,e){super.resize(t,e);let o=Math.abs(this.rt.x-this.lt.x)??.1;this.fontSize=At.calculatorFontSize(this.text,o,this.fontSize);let i=At.calculatorFontWidthHeight(this.text,this.fontSize).height,n=0;switch(t){case k:case I:n=this.rb.y-i,this.lt.y=n,this.rt.y=n;break;case U:case H:n=this.rt.y+i,this.lb.y=n,this.rb.y=n}this.updateSelectPosition()}render(t){t.drawLabel(this)}}class jt extends g{constructor(t){super(),this.label=t.page.newControl,this.textEditor=t.textEditor,this.textEditor.updateLabel(this.label),t.enabledShortcut=!1,this.isDown=!1,t.page.setCursor(tt),t.historyManager.startUndo(new B("undo create label",(()=>{t.page.removeControl(this.label)})))}get type(){return p}onMouseDown(t){if(this.isDown){if(t.editor.clearCommand(),""===this.textEditor.val)return void this.textEditor.hide();this.label.text=this.textEditor.val+"";const e=this.label.lt.x,o=this.label.lt.y,i=this.textEditor.getSize(),n=e+i.width+5,s=o+i.height;return this.label.rt.x=n,this.label.rt.y=o,this.label.lb.x=e,this.label.lb.y=s,this.label.rb.x=n,this.label.rb.y=s,this.label.updatePosition(),t.editor.page.addControl(this.label),this.textEditor.hide(),void t.editor.historyManager.endUndo(new B("redo create label",(()=>{t.editor.page.addControl(this.label)})))}this.isDown=!0,this.label.lt.x=t.point.x,this.label.lt.y=t.point.y,t.originEvent.preventDefault(),this.textEditor.show(t.clientPoint),this.textEditor.focus()}onMouseMove(t){super.onMouseMove(t)}onMouseUp(t){super.onMouseUp(t)}onMouseWheel(t){super.onMouseWheel(t)}onKeyDown(t){this.isDown||"Escape"!==t.originEvent.key||(t.editor.enabledShortcut=!0,t.editor.page.setCursor(X),t.editor.tools.clear())}}class Qt extends P{constructor(t){super(t),this.handler=new jt(t)}active(){this.editor.addEventHandler(this.handler)}deActive(){this.editor.removeEventHandler(this.handler)}}class Yt extends g{constructor(t){super(),this._label=t.page.selectControl.control,this._label.text=""}onMouseDown(t){const e=t.editor.textEditor;if(t.editor.clearCommand(),e.hide(),""===e.val)return void t.editor.page.removeControl(this._label);const o=e.val+"",i=this._label.lt.x,n=this._label.lt.y;let s=At.calculatorFontWidthHeight(o,this._label.fontSize);const r=i+s.width,l=n+s.height;this._label.rt.x=r,this._label.rt.y=n,this._label.lb.x=i,this._label.lb.y=l,this._label.rb.x=r,this._label.rb.y=l,this._label.text=o}}class Gt extends P{constructor(t){super(t),this.handler=new Yt(t)}active(){this.editor.addEventHandler(this.handler)}deActive(){this.editor.removeEventHandler(this.handler)}}class Xt{constructor(t){this.editor=t,this.commandManager=new j;const e=t.historyManager;this.createLine=e=>{t.page.newControl=this.#c(e,new Wt),this.commandManager.execute(new F(t)),t.render()},this.createRect=e=>{t.page.newControl=this.#c(e,new kt),this.commandManager.execute(new N(t)),t.render()},this.createTriangle=e=>{t.page.newControl=this.#c(e,new Ot),this.commandManager.execute(new Pt(t)),t.render()},this.createCircle=e=>{t.page.newControl=this.#c(e,new Kt),this.commandManager.execute(new Tt(t)),t.render()},this.createImage=()=>{this.#p((t=>{this.commandManager.execute(new Ht(this.editor,t))}))},this.createLabel=e=>{t.page.newControl=this.#c(e,new Nt),this.commandManager.execute(new Qt(this.editor)),t.render()},this.editeLabel=()=>{this.commandManager.execute(new Gt(this.editor)),this.editor.page.selectControl=null,this.editor.page.hoverControl=null,t.render()},this.undo=()=>{e.undo()},this.redo=()=>{e.redo()},this.clear=()=>{t.removeForegroundRender(),this.commandManager.execute(new vt(t)),t.render()},this.commandManager.execute(new vt(t))}#c(t,e){return void 0!==t&&e.setPosition(t),e}#p(t){const e=document.createElement("input");e.type="file",e.accept="image/*",e.style.display="none",e.addEventListener("change",(e=>{const o=new FileReader;o.onload=function(e){const o=new Image;o.onload=function(){t(o)},o.src=e.target.result},o.readAsDataURL(e.target.files[0])})),e.click()}}class qt extends P{constructor(t,e){super(),this.undo=t,this.redo=e}active(){this.undo()}deActive(){this.redo()}}class $t{constructor(t){this.editor=t,this.undoQue=[],this.redoQue=[],this.undoAction=null}undo(){if(0===this.undoQue.length)return;const t=this.undoQue.pop();t.active(),this.editor.render(),this.redoQue.push(t)}redo(){if(0===this.redoQue.length)return;const t=this.redoQue.pop();t.deActive(),this.editor.render(),this.undoQue.push(t)}startUndo(t){this.undoAction=t}endUndo(t){const e=this.undoAction,o=new qt((()=>e.run()),(()=>t.run()));this.undoQue.push(o),this.redoQue=[],this.undoAction=null}}class Zt{constructor(t){this.#u(),this._editor=t,this._coordinate=t.page.coordinate,At.setEditor(t)}updateLabel(t){this._label=t,this._input.value=t.text,this.#g()}#u(){const t=document.getElementById("text-editor");t?this._input=t:(this._input=document.createElement("input"),this._input.id="text-editor",this._input.className="absolute pl-1 bg-transparent focus:border-transparent",this._input.addEventListener("keydown",(t=>{this.update()})),document.body.appendChild(this._input))}#g(){const t=this._input.getBoundingClientRect();let e=this.getSize(this._coordinate.dpr).width+At.getWhiteSpace(),o=t.x+e;const i=this._editor.maxPosition,n=o-i.x;n>0&&(e-=n);const s=t.y+t.height-i.y;if(s>0){const t=Number(this._input.style.top.slice(0,-2));this._input.style.top=t-s+"px"}this._input.style.width=e+"px"}getSize(t){let e=this._label.fontSize;return t&&(e*=t),At.calculatorFontWidthHeight(this._input.value,e)}show(t){const e=this._input,o=this._editor.minPosition,i=Math.max(o.x,t.x),n=Math.max(o.y,t.y);e.style.top=n+window.scrollY+"px",e.style.left=i+window.scrollX+"px",e.style.fontSize=this._label.fontSize*this._coordinate.dpr+"px",e.classList.remove("hidden"),this._editor.enabledShortcut=!1,this.update(),this.focus()}focus(){this._input.focus()}hide(){this._editor.enabledShortcut=!0,this._input.classList.add("hidden")}update(){this.#g()}get val(){return this._input.value}get width(){return Math.round(this._input.style.width.slice(0,-2))}}class Jt extends B{constructor(t,e){const o=e.lineColor;super(t,(()=>{e.lineColor=o}))}}class Vt extends B{constructor(t,e){const o=e.fillColor;super(t,(()=>{e.fillColor=o}))}}class te extends B{constructor(t,e){const o=e.lineStyle;super(t,(()=>{e.lineStyle=o}))}}class ee extends B{constructor(t,e){const o=e.lineWidth;super(t,(()=>{e.lineWidth=o}))}}class oe extends B{constructor(t,e){const o=e.fontColor;super(t,(()=>{e.fontColor=o}))}}const ie="hidden pointer-events-auto flex items-center rounded-md border border-slate-300 shadow-sm bg-background bg-slate-100 text-foreground absolute gap-0.5 p-1";class ne{constructor(t){this._editor=t,this._tools=t.tools,this._toolbarWrap=document.createElement("div"),this._toolbarWrap.className="flex w-52 m-2"}get toolbarWrap(){return this._toolbarWrap}createToolbar(t){const e=document.createElement("div");e.id="toolbar",e.className="pointer-events-auto flex items-center rounded-md border border-slate-200 shadow-sm bg-background text-foreground relative gap-0.5 p-0.5 p-1 pl-3 pr-1";const o=this.#y("./src/icon/line.png","Q",(()=>{this._tools.createLine()})),i=this.#y("./src/icon/rect.png","W",(()=>{this._tools.createRect()})),n=this.#y("./src/icon/triangle.png","E",(()=>{this._tools.createTriangle()})),s=this.#y("./src/icon/circle.png","R",(()=>{this._tools.createCircle()})),r=this.#y("./src/icon/image.png","T",(()=>{this._tools.createImage()})),l=this.#y("./src/icon/label.png","A",(()=>{this._tools.createLabel()}));e.appendChild(o),e.appendChild(i),e.appendChild(n),e.appendChild(s),e.appendChild(r),e.appendChild(l);const a=document.createElement("div");a.className="shrink-0 bg-border h-full w-[1px] mr-2 dark:bg-gray-300",a.role="none",e.appendChild(a);const h=this.#y("./src/icon/undo.png","Z",(()=>{this._tools.undo()})),d=this.#y("./src/icon/redo.png","Y",(()=>{this._tools.redo()}));e.appendChild(h),e.appendChild(d),this._toolbarWrap.appendChild(e),t.appendChild(this.#x()),t.appendChild(this.#m()),t.appendChild(this._toolbarWrap)}#m(){const t=document.createElement("div");t.id="font-option",t.className=ie;const e=document.createElement("p");e.className="w-20 h-8 px-2 inline-flex items-center justify-center rounded hover:bg-slate-200";const o=document.createElement("img");o.src="./src/icon/font_size.png",o.className="w-4 h-4 mr-2";const i=document.createElement("input");i.id="font-size",i.type="number",i.className="w-10 h-5 text-right",i.addEventListener("input",(t=>{let e=t.target.value?parseInt(t.target.value,10):1;e<=0&&(e=1,i.value=1);const o=this._editor.page.selectControl.control;o.fontSize=e;const n=At.calculatorFontWidthHeight(o.text,o.fontSize),s=o.lt,r=o.rb;r.x=s.x+n.width,r.y=s.y+n.height,o.lb.y=s.y+n.height,o.rt.x=s.x+n.width,o.updatePosition(),this._editor.render()})),e.appendChild(o),e.appendChild(i);const n=this.#b("font-color",{x:mt,y:pt},(t=>{const e=this._editor.page.selectControl.control;this._editor.historyManager.startUndo(new oe("undo font color",e)),e.fontColor=t,this._editor.historyManager.endUndo(new oe("redo font color",e))})),s=this.#y("./src/icon/font_color.png","",(()=>{bt.getInstance().showFontColorToolbar()}));return t.appendChild(e),t.appendChild(s),t.appendChild(n),t}#x(){const t=document.createElement("div");t.id="line-option",t.className=ie;const e=this.#w(),o=this.#y("./src/icon/line_width.png","",(()=>{bt.getInstance().showLineWidthToolbar()})),i=this.#_(),n=this.#y("./src/icon/line_style.png","",(()=>{bt.getInstance().showLineStyleToolbar()})),s=this.#b("line-color",{x:yt,y:pt},(t=>{const e=this._editor.page.selectControl.control;this._editor.historyManager.startUndo(new Jt("undo line color",e)),e.lineColor=t,this._editor.historyManager.endUndo(new Jt("redo line color",e))}));s.classList.add("bg-slate-200");const r=this.#y("./src/icon/line_color.png","",(()=>{bt.getInstance().showLineColorToolbar()})),l=this.#b("fill-color",{x:yt,y:pt},(t=>{const e=this._editor.page.selectControl.control;this._editor.historyManager.startUndo(new Vt("undo fill color",e)),this._editor.page.selectControl.control.fillColor=t,this._editor.historyManager.endUndo(new Vt("redo fill color",e))}));l.classList.add("bg-slate-300");const a=this.#y("./src/icon/fill_color.png","",(()=>{bt.getInstance().showFillColorToolbar()}));return a.id="fill-color-btn",t.appendChild(o),t.appendChild(n),t.appendChild(r),t.appendChild(a),t.appendChild(e),t.appendChild(i),t.appendChild(s),t.appendChild(l),t}#b(t,e,o){const i=document.createElement("div");i.id=t,i.style.left=e.x+"px",i.style.top=e.y+"px",i.className=ie;return["rgb(255,255,255)","rgb(0,0,0)","rgb(113,113,113)","rgb(216,61,27)","rgb(236,145,38)","rgb(233,186,31)","rgb(28,138,79)","rgb(14,136,224)","rgb(134,57,235)"].forEach((t=>{const e=this.#v(t,(()=>{o(t),this._editor.render()}));i.appendChild(e)})),i}#_(){const t=document.createElement("div");t.id="line-style",t.style.left=gt+"px",t.style.top=pt+"px",t.className=ie;const e=this.#y("./src/icon/line_width_1.png","",(()=>{const t=this._editor.page.selectControl.control;this.#C(t,w),this._editor.render()}));t.appendChild(e);const o=this.#y("./src/icon/line_dash.png","",(()=>{const t=this._editor.page.selectControl.control;this.#C(t,_),this._editor.render()}));return t.appendChild(o),t}#C(t,e){this._editor.historyManager.startUndo(new te("undo line Style",t)),t.lineStyle=e,this._editor.historyManager.endUndo(new te("redo line Style",t))}#w(){const t=document.createElement("div");t.id="line-width",t.style.left=ut+"px",t.style.top=pt+"px",t.className=ie;for(let e=1;e<=5;++e){const o=document.createElement("button");o.className="w-8 h-8 ml-1 mr-1 pl-1 pr-1 inline-flex items-center justify-center rounded hover:bg-slate-200",o.addEventListener("click",(()=>{const t=this._editor.page.selectControl.control;this._editor.historyManager.startUndo(new ee("undo line width",t)),t.lineWidth=e,this._editor.historyManager.endUndo(new ee("redo line width",t)),this._editor.render()}));const i=document.createElement("span");i.style.height="0px",i.style.width="30px",i.style.borderWidth=e+"px",i.className="border-black",o.appendChild(i),t.appendChild(o)}return t}#v(t,e){const o=document.createElement("div");o.className="relative flex item-center justify-center mr-1 pt-0.5 pb-0.5 rounded-full hover:bg-slate-300";const i=document.createElement("button");return i.className="w-6 h-6 mt-1 mb-1 ml-2 mr-2 inline-flex items-center justify-center rounded-full",i.style.backgroundColor=t,i.addEventListener("click",e),o.appendChild(i),o}#y(t,e,o){const i=document.createElement("div");i.className="relative flex item-center justify-center mr-1";const n=document.createElement("img");n.src=t,n.className="w-5 h-5";const s=document.createElement("button");if(s.className="w-8 h-8 inline-flex items-center justify-center rounded hover:bg-slate-200",s.addEventListener("click",o),s.appendChild(n),i.appendChild(s),""!==e){n.classList.add("mr-2");const t=document.createElement("div");t.className="w-2 h-3 items-center justify-center absolute right-0 bottom-0 text-[8px] opacity-40",t.textContent=e,i.appendChild(t)}return i}}class se{constructor(t,{width:e,height:o}){const i=document.getElementById(t);i.className="m-5",this.canvas=document.createElement("canvas"),this.canvas.style.border="solid 2px #000",this.canvas.width=500*e,this.canvas.height=500*o,this.ctx=this.canvas.getContext("2d"),this.page=new f(this.ctx),this.eventManager=new b(this),this._historyManager=new $t(this),this._tools=new Xt(this),this._toolbar=new ne(this),this._textEditor=new Zt(this),this.foregroundRender=null,this._enabledShortcut=!0,this.#u(i)}#u(t){this._toolbar.createToolbar(t),t.appendChild(this.canvas),this.page.render(),this.canvas.addEventListener("dblclick",(t=>{this.eventManager.onDoubleClick(t)})),this.canvas.addEventListener("mousedown",(t=>{this.eventManager.onMouseDown(t)})),this.canvas.addEventListener("mousemove",(t=>{this.eventManager.onMouseMove(t)})),this.canvas.addEventListener("mouseup",(t=>{this.eventManager.onMouseUp(t)})),this.canvas.addEventListener("wheel",(t=>{this.eventManager.onMouseWheel(t)})),document.addEventListener("keydown",(t=>{this.eventManager.onKeyDown(t)})),document.addEventListener("keyup",(t=>{this.eventManager.onKeyUp(t)}))}capture(){this.#f();const t=document.createElement("a");t.href=this.save(),t.download="canvas_image.png",t.click(),this.render()}save(){return this.#f(),this.canvas.toDataURL("image/png")}#f(){this.page.captureRender()}get enabledShortcut(){return this._enabledShortcut}set enabledShortcut(t){this._enabledShortcut=t}addEventHandler(t){this.eventManager.addHandler(t)}removeEventHandler(t){this.eventManager.removeHandler(t)}addForegroundRender(t){this.foregroundRender=t}removeForegroundRender(){this.foregroundRender=null}startDragHandler(t){bt.getInstance().clear(),this.eventManager.startDragHandler(t)}finishDragHandler(){this.eventManager.finishDragHandler()}clearCommand(){this._tools.clear()}render(){this.page.render(),this.foregroundRender?.render(this.page.painter)}get toolbar(){return this._toolbar}get tools(){return this._tools}get textEditor(){return this._textEditor}get historyManager(){return this._historyManager}get maxPosition(){const t=this.canvas.getBoundingClientRect();return{x:t.right,y:t.y+t.height}}get minPosition(){const t=this.canvas.getBoundingClientRect(),e=Number(this.canvas.style.borderWidth.slice(0,-2));return{x:t.x+e,y:t.y+e}}}KPS=e})();